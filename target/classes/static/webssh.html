<!doctype html>
<html lang="zh" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>WebSSH</title>
    <link href="css/xterm.css" rel="stylesheet"/>
</head>
<body style="height: 100%; margin: 0">
<div id="terminal" style="width: 100%;height: 100%"></div>

<script src="js/jquery-3.4.1.min.js"></script>
<script charset="utf-8" src="js/xterm.js"></script>
<script charset="utf-8" src="js/webssh.js"></script>
<script>

    // 尝试搜索 url 中的参数
    const params = {};
    params.operate = "connect";
    window.location.search.substring(1).split("&").forEach(function (item) {
        const kv = item.split("=");
        params[kv[0]] = kv[1];
    });
    if (params.password) {
        params.password = atob(decodeURIComponent(decodeURIComponent(params.password)));
    }

    function extracted(numberKey, defaultValue, stringValue) {
        if (params[numberKey]) {
            return;
        }
        const s = prompt(stringValue, defaultValue);
        if (s) {
            params[numberKey] = s;
        } else {
            alert("参数不能为空");
            extracted(numberKey, defaultValue, stringValue);
        }
    }

    extracted("host", "127.0.0.1", "请输入您要连接的主机IP/域名！");
    extracted("port", "22", `请输入您要连接到 ${params.host} 的ssh端口`);
    extracted("username", "root", `请输入您要连接到 ${params.host}:${params.port} 的用户名`);
    extracted("password", "123456", `请输入您要连接到 ${params.username}@${params.host} 的密码~`);

    // 开始启动
    openTerminal(params);

    function openTerminal(options) {
        const client = new WSSHClient();
        const term = new Terminal({
            cursorBlink: true, // 光标闪烁
            cursorStyle: "bar", // 光标样式  null | 'block' | 'underline' | 'bar'
            scrollback: 800, //回滚
            tabStopWidth: 8, //制表宽度
            screenKeys: true
        });

        term.on('data', function (data) {
            //键盘输入时的回调函数
            client.sendClientData(data);
        });
        term.open(document.getElementById('terminal'));

        //在页面上显示连接中...
        term.write('Connecting...\r\n');
        //执行连接操作
        client.connect({
            onError: function (error) {
                //连接失败回调
                term.write('Error: ' + error + '\r\n');
            },
            onConnect: function () {
                //连接成功回调
                client.sendInitData(options);
            },
            onClose: function () {
                //连接关闭回调
                term.write("\rconnection closed\r\n");
                term.write("\rAfter 5 seconds, return to the login interface\r\n");
                let s = 4;
                setInterval(() => {
                    term.write(`\rAfter ${s} seconds, return to the login interface\r\n`);
                    if (s-- <= 0) {
                        window.location.href = "index.html";
                    }
                }, 1000);
            },
            //收到数据时回调
            onData: function (data) {
                term.write(data);
            }
        });


        function resizeTerminal() {
            const element = document.getElementById('terminal');
            // 获取字体大小和行高
            const fontSize = 10;
            const lineHeight = 18;

            // 计算列数和行数
            const cols = Math.floor(element.clientWidth / fontSize);
            const rows = Math.floor(element.clientHeight / lineHeight);

            term.resize(cols, rows);

            document.querySelector(".xterm-viewport").style.height = '100vh';
        }

        // 初始化时调用一次
        resizeTerminal();
    }
</script>
</body>
</html>